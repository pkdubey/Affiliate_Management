{% extends 'base.html' %}
{% block content %}

<style>
/* Existing list styles remain the same */
.invoice-list-card {
    border-radius: 1.5rem;
    background: rgba(255,255,255,0.95);
    box-shadow: 0 4px 32px #1dbfae22, 0 1.5px 7px #1963b319;
    border: 1.5px solid rgba(29,191,174,.11);
    backdrop-filter: blur(6px);
    animation: fadeCardList 0.8s cubic-bezier(.75,.14,.54,.99);
    padding: 0;
    overflow: hidden;
}

@keyframes fadeCardList {
    from { opacity:0; transform: translateY(30px);}
    to   { opacity:1; transform: none;}
}

.animated-table tbody tr {
    transition: box-shadow .18s, background .22s;
}

.animated-table tbody tr:hover {
    background: linear-gradient(90deg, #1dbfae11, #1963b30b 80%);
    box-shadow: 0 2px 16px #1dbfae29;
}

.animated-table thead th {
    color: #1963b3;
    font-weight: bold;
    letter-spacing: .03em;
    background: rgba(250,253,253,.96);
    border-bottom: 2px solid #1dbfae33 !important;
}

.animated-table td, .animated-table th {
    vertical-align: middle;
    text-align: center;
}

.invoice-status {
    border-radius: .6rem;
    font-size: .95em;
    padding: .25em .9em;
    font-weight: 600;
    display: inline-block;
    background: #eaf9ff;
}

.invoice-status.paid { background: #e8fbe9; color: #0a944e; }
.invoice-status.pending { background: #fffbe6; color: #93890a;}
.invoice-status.cancelled { background: #ffe5e6; color: #b71e36; }
.invoice-status.overdue { background:#fff3ed; color:#b4411c;}

.invoice-action-btn {
    font-size: 1em;
    border: none;
    outline: none;
    background: none;
    color: #1dbfae;
    padding: 0 .2em;
    transition: color .2s, text-shadow .18s;
}

.invoice-action-btn:hover {
    color: #1963b3;
    text-shadow: 0 2px 12px #1dbfae1a;
}

.add-invoice-btn {
    background: linear-gradient(90deg, #1dbfae 0 53%, #1963b3 100%);
    color: #fff;
    font-weight: 600;
    border: none;
    border-radius: 1.2rem;
    padding: .45rem 1.3rem;
    box-shadow: 0 2px 14px #1dbfae38;
    transition: background .19s, box-shadow .19s, transform .13s;
}

.add-invoice-btn:hover, .add-invoice-btn:focus {
    background: linear-gradient(90deg, #1963b3 10%, #1dbfae 90%);
    box-shadow: 0 4px 24px #1dbfae57;
    color: #fff;
    transform: translateY(-2px);
}

.invoice-table-responsive {
    overflow-x: auto;
    margin-top: 1.7rem;
}

/* Badge for impersonation */
.impersonate-badge {
    background: #ffc107;
    color: #000;
    padding: 0.25rem 0.75rem;
    border-radius: 0.5rem;
    font-size: 0.85rem;
    font-weight: 600;
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
}

/* Modal Styles - Light Theme */
.invoice-modal {
    display: none;
    position: fixed;
    z-index: 1050;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    background: rgba(0,0,0,0.4);
    backdrop-filter: blur(2px);
}

.invoice-modal.show {
    display: block;
    animation: fadeInModal 0.3s ease-out;
}

@keyframes fadeInModal {
    from { opacity: 0; }
    to { opacity: 1; }
}

.invoice-modal-dialog {
    position: relative;
    width: auto;
    max-width: 1000px;
    margin: 1rem auto;
    pointer-events: none;
    padding: 0 15px;
    height: calc(100vh - 2rem);
    display: flex;
    align-items: flex-start;
    padding-top: 2rem;
}

.invoice-modal-content {
    position: relative;
    pointer-events: auto;
    background: #ffffff;
    border: none;
    border-radius: 1rem;
    box-shadow: 0 10px 40px rgba(0, 0, 0, 0.15);
    width: 100%;
    max-height: calc(100vh - 4rem);
    overflow-y: auto;
    animation: slideInModal 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94);
}

@keyframes slideInModal {
    from { 
        transform: translateY(-30px) scale(0.98);
        opacity: 0;
    }
    to { 
        transform: translateY(0) scale(1);
        opacity: 1;
    }
}

.invoice-modal-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 1.5rem 2rem;
    border-bottom: 1px solid #e9ecef;
    background: #ffffff;
    border-radius: 1rem 1rem 0 0;
}

.invoice-modal-title {
    margin: 0;
    color: #2c3e50;
    font-size: 1.4rem;
    font-weight: 600;
}

.invoice-modal-close {
    background: none;
    border: none;
    font-size: 1.5rem;
    color: #6c757d;
    cursor: pointer;
    padding: 0;
    width: 32px;
    height: 32px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 50%;
    transition: background-color 0.2s, color 0.2s;
}

.invoice-modal-close:hover {
    background: #f8f9fa;
    color: #495057;
}

.invoice-modal-body {
    padding: 1rem;
    background: #ffffff;
}

/* Form Styles - Light Theme */
.form-section {
    margin-bottom: 1.25rem;
}

.section-title {
    font-size: 1.1rem;
    font-weight: 600;
    color: #2c3e50;
    margin-bottom: 1rem;
    padding-bottom: 0.5rem;
    border-bottom: 2px solid #e9ecef;
}

.form-row {
    margin-bottom: 1.5rem;
}

.form-group {
    margin-bottom: 0.75rem;
}

.form-label {
    color: #495057;
    font-weight: 500;
    margin-bottom: 0.5rem;
    display: block;
    font-size: 0.9rem;
}

.form-control {
    width: 100%;
    padding: 0.75rem 1rem;
    border: 1px solid #ced4da;
    border-radius: 0.375rem;
    background: #ffffff;
    color: #495057;
    font-size: 0.95rem;
    transition: border-color 0.15s ease-in-out, box-shadow 0.15s ease-in-out;
}

.form-control:focus {
    outline: none;
    border-color: #80bdff;
    box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);
    background: #ffffff;
}

.form-select {
    appearance: none;
    background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e");
    background-position: right 0.75rem center;
    background-repeat: no-repeat;
    background-size: 16px 12px;
    padding-right: 2.5rem;
}

/* Items Table */
.items-table {
    width: 100%;
    border-collapse: collapse;
    background: #ffffff;
    border: 1px solid #dee2e6;
    border-radius: 0.375rem;
    overflow: hidden;
    margin-bottom: 1rem;
}

.items-table th {
    background: #f8f9fa;
    color: #495057;
    font-weight: 600;
    padding: 0.75rem;
    text-align: left;
    border-bottom: 1px solid #dee2e6;
    font-size: 0.9rem;
}

.items-table td {
    padding: 0.75rem;
    border-bottom: 1px solid #f1f3f4;
    vertical-align: middle;
}

.items-table tbody tr:hover {
    background: #f8f9fa;
}

.item-remove {
    color: #dc3545;
    cursor: pointer;
    font-size: 1rem;
    transition: color 0.2s;
}

.item-remove:hover {
    color: #c82333;
}

.add-item-row {
    display: flex;
    gap: 0.5rem;
    align-items: end;
    margin-top: 1rem;
    flex-wrap: wrap;
}

.add-item-row .form-control {
    margin-bottom: 0;
}

.add-item-btn {
    background: #28a745;
    color: white;
    border: none;
    padding: 0.75rem 1rem;
    border-radius: 0.375rem;
    font-weight: 500;
    cursor: pointer;
    transition: background-color 0.15s ease-in-out;
    white-space: nowrap;
}

.add-item-btn:hover {
    background: #218838;
}

/* Totals Section */
.totals-section {
    background: #f8f9fa;
    border-radius: 0.5rem;
    padding: 1.5rem;
    margin-top: 1.5rem;
    border: 1px solid #e9ecef;
}

.total-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 0.5rem;
    font-size: 0.95rem;
}

.total-row.final {
    font-size: 1.25rem;
    font-weight: 700;
    color: #2c3e50;
    border-top: 2px solid #dee2e6;
    padding-top: 0.75rem;
    margin-top: 0.75rem;
    margin-bottom: 0;
}

/* Modal Footer */
.modal-footer {
    display: flex;
    justify-content: flex-end;
    gap: 1rem;
    padding: 1.5rem 2rem;
    border-top: 1px solid #dee2e6;
    background: #f8f9fa;
    border-radius: 0 0 1rem 1rem;
}

.btn-cancel {
    background: #ffffff;
    color: #6c757d;
    border: 1px solid #ced4da;
    padding: 0.5rem 1.5rem;
    border-radius: 0.375rem;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.15s ease-in-out;
}

.btn-cancel:hover {
    background: #e9ecef;
    border-color: #adb5bd;
}

.btn-save {
    background: #007bff;
    color: white;
    border: none;
    padding: 0.5rem 2rem;
    border-radius: 0.375rem;
    font-weight: 500;
    cursor: pointer;
    transition: background-color 0.15s ease-in-out;
}

.btn-save:hover {
    background: #0056b3;
}

.btn-save:disabled {
    background: #6c757d;
    cursor: not-allowed;
}

/* File upload styles */
.file-upload-zone {
    border: 2px dashed #dee2e6;
    border-radius: 0.5rem;
    padding: 2rem;
    text-align: center;
    transition: border-color 0.3s;
    background: #f8f9fa;
}

.file-upload-zone:hover {
    border-color: #007bff;
    background: #e3f2fd;
}

.file-upload-zone.dragover {
    border-color: #007bff;
    background: #e3f2fd;
}

.file-info {
    margin-top: 0.5rem;
    font-size: 0.85rem;
    color: #6c757d;
}

.upload-progress {
    width: 100%;
    height: 4px;
    background: #e9ecef;
    border-radius: 2px;
    margin-top: 0.5rem;
    overflow: hidden;
}

.upload-progress-bar {
    height: 100%;
    background: linear-gradient(90deg, #1dbfae, #1963b3);
    border-radius: 2px;
    transition: width 0.3s;
}

/* Responsive Design */
@media (max-width: 768px) {
    .invoice-modal-dialog {
        margin: 0.5rem auto;
        height: calc(100vh - 1rem);
        padding: 0 10px;
        padding-top: 1rem;
    }
    
    .invoice-modal-content {
        max-height: calc(100vh - 2rem);
    }
    
    .invoice-modal-body {
        padding: 1rem;
    }
    
    .add-item-row {
        flex-direction: column;
    }
    
    .add-item-row .form-control {
        width: 100%;
    }
    
    .modal-footer {
        flex-direction: column-reverse;
        gap: 0.5rem;
    }
    
    .btn-cancel,
    .btn-save {
        width: 100%;
    }
}

/* Small text inputs for better alignment */
.small-input {
    max-width: 120px;
}

.medium-input {
    max-width: 200px;
}
</style>

<div class="card invoice-list-card mx-auto">
  <div class="d-flex flex-wrap justify-content-between align-items-center px-4 py-4 border-bottom">
    <h2 class="fs-3 mb-0 d-flex align-items-center gap-2" style="color:#1963b3">
      <i class="bi bi-receipt"></i> 
      {% if publisher_only_view %}
        {% if is_impersonating %}
          Publisher Invoices - {{ current_publisher.company_name }}
          <span class="impersonate-badge">
            <i class="bi bi-eye"></i> Impersonating
          </span>
        {% else %}
          My Invoices
        {% endif %}
      {% else %}
        Invoices
      {% endif %}
    </h2>
    
    {% if show_tabs %}
      {% if active_tab == 'advertiser' %}
        <button type="button" class="add-invoice-btn d-flex align-items-center gap-2" onclick="openInvoiceModal()">
          <i class="bi bi-plus-lg"></i> Create Advertiser Invoice
        </button>
      {% else %}
        <button type="button" class="add-invoice-btn d-flex align-items-center gap-2" onclick="openPublisherModal()">
          <i class="bi bi-upload"></i> Upload Publisher Invoice
        </button>
      {% endif %}
    {% else %}
      <!-- Publisher-only view: only upload button -->
      <button type="button" class="add-invoice-btn d-flex align-items-center gap-2" onclick="openPublisherModal()">
        <i class="bi bi-upload"></i> Upload Invoice
      </button>
    {% endif %}
  </div>

  <div class="px-4 pt-3 pb-0">
    {% if show_tabs %}
      <!-- Show tabs for admin/subadmin -->
      <ul class="nav nav-tabs mb-3" id="invoiceTabs">
        <li class="nav-item">
          <a class="nav-link {% if active_tab == 'advertiser' %}active{% endif %}" href="?tab=advertiser{% if selected_status %}&status={{ selected_status }}{% endif %}">Advertiser Invoices</a>
        </li>
        <li class="nav-item">
          <a class="nav-link {% if active_tab == 'publisher' %}active{% endif %}" href="?tab=publisher{% if selected_status %}&status={{ selected_status }}{% endif %}">Publisher Invoices</a>
        </li>
      </ul>
    {% endif %}

    <form method="get" class="row g-2 mb-3 align-items-center">
      <input type="hidden" name="tab" value="{{ active_tab }}">
      
      {% if show_tabs %}
        <div class="col-auto">
          <select name="client" class="form-select" onchange="this.form.submit()">
            <option value="">All Clients</option>
            {% for client in clients %}
              <option value="{{ client.id }}" {% if selected_client == client.id|stringformat:'s' %}selected{% endif %}>{{ client.company_name }}</option>
            {% endfor %}
          </select>
        </div>
      {% endif %}
      
      <div class="col-auto">
        <select name="month" class="form-select" onchange="this.form.submit()">
          <option value="">All Months</option>
          {% for value, name in months %}
            <option value="{{ value }}" {% if selected_month == value %}selected{% endif %}>{{ name }}</option>
          {% endfor %}
        </select>
      </div>
      
      <div class="col-auto">
        <select name="status" class="form-select" onchange="this.form.submit()">
          <option value="">All Statuses</option>
          <option value="Paid" {% if selected_status == 'Paid' %}selected{% endif %}>Paid</option>
          <option value="Pending" {% if selected_status == 'Pending' %}selected{% endif %}>Pending</option>
          <option value="Overdue" {% if selected_status == 'Overdue' %}selected{% endif %}>Overdue</option>
        </select>
      </div>
    </form>
  </div>

  <div class="invoice-table-responsive px-2 px-md-4 py-3">
    <table class="table table-hover animated-table align-middle mb-0">
      <thead>
        <tr>
          <th>ID</th>
          <th>Invoice#</th>
          <th>Client</th>
          <th>Amount</th>
          <th>Due Date</th>
          <th>Status</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody>
      {% for invoice in invoices %}
        <tr>
          <td><span class="fw-bold text-primary">#{{ invoice.id }}</span></td>
          <td>
            <span class="fw-bold" style="color:#1963b3;">{{ invoice.invoice_number }}</span>
            <div class="text-muted small">{{ invoice.created_at|date:'d-m-Y' }}</div>
          </td>
          <td>{% if active_tab == 'advertiser' %}{{ invoice.advertiser }}{% else %}{{ invoice.publisher }}{% endif %}</td>
          <td>{{ invoice.total_amount }}</td>
          <td>{{ invoice.due_date }}</td>
          <td>
            <span class="invoice-status {% if invoice.status == 'Paid' %}paid{% elif invoice.status == 'Pending' %}pending{% elif invoice.status == 'Cancelled' %}cancelled{% elif invoice.status == 'Overdue' %}overdue{% endif %}">
              {{ invoice.status }}
            </span>
          </td>
          <td>
            <a href="{% url 'invoicing:detail' invoice.id %}" class="invoice-action-btn" title="View">
              <i class="bi bi-eye"></i>
            </a>
            {% if not publisher_only_view %}
              <button class="invoice-action-btn" title="Edit" onclick="location.href='{% url 'invoicing:edit' invoice.id %}'">
                <i class="bi bi-pencil-square"></i>
              </button>
              <a href="{% url 'invoicing:delete' invoice.id %}" class="invoice-action-btn" title="Delete">
                <i class="bi bi-trash"></i>
              </a>
            {% endif %}
            <a href="{% url 'invoicing:pdf' invoice.id %}" class="invoice-action-btn" title="Download PDF">
              <i class="bi bi-file-earmark-pdf"></i>
            </a>
          </td>
        </tr>
      {% empty %}
        <tr>
          <td colspan="7" class="text-secondary py-5">
            <i class="bi bi-inbox fs-1 d-block mb-2"></i>
            No invoices found.
          </td>
        </tr>
      {% endfor %}
      </tbody>
    </table>
  </div>
  
  <!-- Pagination -->
  {% if is_paginated %}
    <nav aria-label="Page navigation" class="px-4 pb-3">
      <ul class="pagination justify-content-center mb-0">
        {% if page_obj.has_previous %}
          <li class="page-item">
            <a class="page-link" href="?page={{ page_obj.previous_page_number }}&tab={{ active_tab }}{% if selected_status %}&status={{ selected_status }}{% endif %}{% if selected_client %}&client={{ selected_client }}{% endif %}{% if selected_month %}&month={{ selected_month }}{% endif %}">Previous</a>
          </li>
        {% endif %}
        
        <li class="page-item active">
          <span class="page-link">{{ page_obj.number }} of {{ page_obj.paginator.num_pages }}</span>
        </li>
        
        {% if page_obj.has_next %}
          <li class="page-item">
            <a class="page-link" href="?page={{ page_obj.next_page_number }}&tab={{ active_tab }}{% if selected_status %}&status={{ selected_status }}{% endif %}{% if selected_client %}&client={{ selected_client }}{% endif %}{% if selected_month %}&month={{ selected_month }}{% endif %}">Next</a>
          </li>
        {% endif %}
      </ul>
    </nav>
  {% endif %}
</div>

<!-- Advertiser Invoice Modal -->
{% if show_tabs and active_tab == 'advertiser' %}
<div class="invoice-modal" id="invoiceModal">
  <div class="invoice-modal-dialog">
    <div class="invoice-modal-content">
      <div class="invoice-modal-header">
        <h3 class="invoice-modal-title">Create Advertiser Invoice</h3>
        <button type="button" class="invoice-modal-close" onclick="closeInvoiceModal()">
          <i class="bi bi-x-lg"></i>
        </button>
      </div>

      <div class="invoice-modal-body">
        <form id="invoiceForm" method="post" action="{% url 'invoicing:add' %}" enctype="multipart/form-data" data-list-url-adv="{% url 'invoicing:invoice_list' %}?tab=advertiser">
          {% csrf_token %}
          <input type="hidden" name="party_type" value="advertiser">

          <!-- Bill From / Bill To -->
          <div class="form-section">
            <div class="row">
              <div class="col-md-6 form-group">
                <label class="form-label">Bill From</label>
                <textarea name="bill_from_details" class="form-control" rows="6" readonly>traccify.ai
0, Seohara Thakurdwara Road
Seohara, Bijnor, Uttar Pradesh, India, 246746

GSTIN: 09AMFPV3992D1ZL
UDYAM-UP-17-0028662</textarea>
              </div>

              <div class="col-md-6 form-group">
                <label class="form-label">Bill To</label>
                <select name="advertiser" class="form-control form-select" id="advertiserSelect" required>
                  <option value="">Select Advertiser</option>
                  {% for client in clients %}
                    <option
                      value="{{ client.id }}"
                      data-company="{{ client.company_name|default_if_none:'' }}"
                      data-contact="{{ client.contact_name|default_if_none:'' }}"
                      data-email="{{ client.email|default_if_none:'' }}"
                      data-item="{{ client.default_item|default_if_none:'Service' }}"
                      data-qty="{{ client.default_qty|default:48 }}"
                      data-rate="{{ client.default_rate|default:50 }}"
                    >{{ client.company_name }}</option>
                  {% endfor %}
                </select>
                <textarea name="bill_to_details" class="form-control mt-2" rows="4" id="billToTextarea" placeholder="Company
Contact
email@example.com"></textarea>
              </div>
            </div>
          </div>

          <!-- Invoice Details Row -->
          <div class="form-section">
            <div class="row">
              <div class="col-md-3 form-group">
                <label class="form-label">Invoice Number</label>
                <input type="text" name="invoice_number" class="form-control" placeholder="INV-001">
              </div>
              <div class="col-md-3 form-group">
                <label class="form-label">Invoice Date</label>
                <input type="date" name="date" class="form-control" required>
              </div>
              <div class="col-md-3 form-group">
                <label class="form-label">Net Terms</label>
                <input type="number" class="form-control" value="30" min="0">
              </div>
              <div class="col-md-3 form-group">
                <label class="form-label">Due Date</label>
                <input type="date" name="due_date" class="form-control" required>
              </div>
            </div>
          </div>

          <!-- Items -->
          <div class="form-section">
            <label class="form-label">Items</label>
            <table class="items-table">
              <thead>
                <tr>
                  <th>ITEM</th>
                  <th style="width: 100px; text-align:center;">QUANTITY</th>
                  <th style="width: 100px; text-align:center;">RATE</th>
                  <th style="width: 120px; text-align:right;">AMOUNT</th>
                  <th style="width: 30px;"></th>
                </tr>
              </thead>
              <tbody id="itemsTableBody"></tbody>
            </table>

            <div class="add-item-row">
              <input type="text" id="itemDescription" class="form-control" placeholder="Item description" style="flex:2;">
              <input type="number" id="itemQuantity" class="form-control small-input" value="1" min="1">
              <input type="number" id="itemRate" class="form-control small-input" value="0" min="0" step="0.01">
              <button type="button" class="add-item-btn" onclick="addItem()">Add Item</button>
            </div>
          </div>

          <!-- Bank + Right column -->
          <div class="form-section">
            <div class="row">
              <div class="col-md-6 form-group">
                <label class="form-label">Bank Details</label>
                <textarea name="bank_details" class="form-control" rows="6">Account Name: traccify.ai
Account No: 50200094727751
IFSC: HDFC0007070
SWIFT CODE: HDFCINBB
Branch: Ward No 12, Gr Flr, Muslim Chowdhirian, Dhampur</textarea>
              </div>

              <div class="col-md-6">
                <div class="row">
                  <div class="col-12 form-group">
                    <label class="form-label">Currency</label>
                    <select name="currency" class="form-control form-select" id="currencySelect">
                      <option value="USD" selected>USD</option>
                      <option value="INR">INR</option>
                      <option value="EUR">EUR</option>
                    </select>
                  </div>
                </div>

                <div class="totals-section">
                  <div class="total-row">
                    <span>Subtotal</span>
                    <span id="subtotalAmount">$0.00</span>
                  </div>
                  <div class="total-row">
                    <span>Tax (0%)</span>
                    <span id="taxAmount">$0.00</span>
                  </div>
                  <div class="total-row final">
                    <span>Total</span>
                    <span id="totalAmount">$0.00</span>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Terms and Status -->
          <div class="form-section">
            <div class="row">
              <div class="col-md-6 form-group" style="margin-top: -4.90rem;">
                <label class="form-label">Terms</label>
                <textarea name="terms" class="form-control" rows="2">Thanks for your business</textarea>
              </div>
              <div class="col-md-6 form-group">
                <label class="form-label">Status</label>
                <select name="status" class="form-control form-select">
                  <option value="Pending" selected>Pending</option>
                  <option value="Paid">Paid</option>
                  <option value="Cancelled">Cancelled</option>
                  <option value="Overdue">Overdue</option>
                </select>
              </div>
            </div>
          </div>

          <!-- Signature -->
          <div class="form-section">
            <div class="row g-3">
              <div class="col-md-6 form-group" style="margin-top: -3.75rem;">
                <label class="form-label">Signature / Stamp (Optional)</label>
                <input type="file" name="signature" class="form-control" accept="image/*">
              </div>
            </div>
          </div>

          <!-- Hidden calc fields -->
          <input type="hidden" name="subtotal" id="hiddenSubtotal" value="0">
          <input type="hidden" name="gst_amount" id="hiddenTax" value="0">
          <input type="hidden" name="amount" id="hiddenAmount" value="0">
          <input type="hidden" name="total_amount" value="0">
          <input type="hidden" name="drs" value="">
        </form>
      </div>

      <div class="modal-footer">
        <button type="button" class="btn-cancel" onclick="closeInvoiceModal()">Cancel</button>
        <button type="submit" form="invoiceForm" class="btn-save">Save Invoice</button>
      </div>
    </div>
  </div>
</div>
{% endif %}

<!-- Publisher Upload Modal -->
<div class="invoice-modal" id="publisherModal">
  <div class="invoice-modal-dialog" style="max-width: 560px;">
    <div class="invoice-modal-content" style="border-radius: 12px;">
      <div class="invoice-modal-header">
        <h3 class="invoice-modal-title" style="font-size:1.15rem;">Upload Publisher Invoice</h3>
        <button type="button" class="invoice-modal-close" onclick="closePublisherModal()">
          <i class="bi bi-x-lg"></i>
        </button>
      </div>

      <div class="invoice-modal-body" style="padding: 1rem 1.25rem 1.25rem;">
        <form id="publisherInvoiceForm" method="post" action="{% url 'invoicing:add' %}" enctype="multipart/form-data" data-list-url-pub="{% url 'invoicing:invoice_list' %}?tab=publisher">
          {% csrf_token %}
          <input type="hidden" name="party_type" value="publisher">

          <div class="form-section" style="margin-bottom: .9rem;">
            <div class="form-group">
              <label class="form-label">Invoice PDF/Image</label>
              <input type="file" name="pdf" class="form-control" accept="application/pdf,image/*,.jpg,.jpeg,.png,.gif">
              <div class="file-info">
                <small class="text-muted">Accepted formats: PDF, JPG, PNG, GIF (Max 10MB)</small>
              </div>
              <div class="upload-progress" style="display: none;">
                <div class="upload-progress-bar" style="width: 0%"></div>
              </div>
            </div>
          </div>

          <div class="form-section" style="margin-bottom: .9rem;">
            <div class="form-group">
              <label class="form-label">Publisher</label>
              <select name="publisher" class="form-control form-select" required {% if publisher_only_view %}readonly{% endif %}>
                <option value="">Select Publisher</option>
                {% for client in clients %}
                  <option value="{{ client.id }}" {% if publisher_only_view and current_publisher.id == client.id %}selected{% endif %}>{{ client.company_name }}</option>
                {% endfor %}
              </select>
            </div>
          </div>

          <div class="form-section" style="margin-bottom: .9rem;">
            <div class="row">
              <div class="col-6 form-group">
                <label class="form-label">Amount</label>
                <input type="number" name="amount" class="form-control" min="0" step="0.01" placeholder="0.00" required>
              </div>
              <div class="col-6 form-group">
                <label class="form-label">Status</label>
                <select name="status" class="form-control form-select" required>
                  <option value="Pending" selected>Pending</option>
                  <option value="Paid">Paid</option>
                  <option value="Cancelled">Cancelled</option>
                  <option value="Overdue">Overdue</option>
                </select>
              </div>
            </div>
          </div>

          <div class="form-section" style="margin-bottom: .2rem;">
            <div class="row">
              <div class="col-6 form-group">
                <label class="form-label">Invoice Date</label>
                <input type="date" name="date" class="form-control" required>
              </div>
              <div class="col-6 form-group">
                <label class="form-label">Due Date</label>
                <input type="date" name="due_date" class="form-control" required>
              </div>
            </div>
          </div>

          <!-- Hidden fields to satisfy model -->
          <input type="hidden" name="invoice_number" value="">
          <input type="hidden" name="currency" value="INR">
          <input type="hidden" name="drs" value="">
          <input type="hidden" name="advertiser" value="">
          <input type="hidden" name="subtotal" value="0">
          <input type="hidden" name="gst_amount" value="0">
          <input type="hidden" name="total_amount" value="0">
          <input type="hidden" name="bill_from_details" value="">
          <input type="hidden" name="bill_to_details" value="">
          <input type="hidden" name="bank_details" value="">
          <input type="hidden" name="terms" value="">
        </form>
      </div>

      <div class="modal-footer" style="padding: 1rem 1.25rem;">
        <button type="button" class="btn-cancel" onclick="closePublisherModal()">Cancel</button>
        <button type="submit" form="publisherInvoiceForm" class="btn-save">Save Invoice</button>
      </div>
    </div>
  </div>
</div>

<script>
/* ======================================================
   Shared State and Utilities
====================================================== */
let items = [];
let itemCounter = 0;

function getCookie(name) {
    const match = document.cookie.match('(^|;)\\s*' + name + '\\s*=\\s*([^;]+)');
    return match ? match.pop() : '';
}

/* ======================================================
   Advertiser Invoice Modal
====================================================== */
function openInvoiceModal() {
    const modal = document.getElementById('invoiceModal');
    if (!modal) {
        console.error('Advertiser modal not found');
        return;
    }

    modal.classList.add('show');
    document.body.style.overflow = 'hidden';

    // FIX: Add [0] at the end
    const today = new Date().toISOString().split('T')[0];  // ✅ FIXED
    const dueDate = new Date();
    dueDate.setDate(dueDate.getDate() + 30);
    const dueDateStr = dueDate.toISOString().split('T')[0];  // ✅ FIXED

    const form = document.getElementById('invoiceForm');
    if (form) {
        const dateInput = form.querySelector('input[name="date"]');
        const dueDateInput = form.querySelector('input[name="due_date"]');

        if (dateInput) dateInput.value = today;
        if (dueDateInput) dueDateInput.value = dueDateStr;

        let pt = form.querySelector('input[name="party_type"]');
        if (!pt) {
            pt = document.createElement('input');
            pt.type = 'hidden';
            pt.name = 'party_type';
            form.appendChild(pt);
        }
        pt.value = 'advertiser';
    }

    items = [];
    itemCounter = 0;
    updateItemsTable();
    updateTotals();
}

function closeInvoiceModal() {
    const modal = document.getElementById('invoiceModal');
    if (!modal) return;

    modal.classList.remove('show');
    document.body.style.overflow = '';

    const form = document.getElementById('invoiceForm');
    if (form) form.reset();

    items = [];
    itemCounter = 0;
    updateItemsTable();
    updateTotals();
}

/* ======================================================
   Item Helpers (Shared by Advertiser)
====================================================== */
function addItem() {
    const desc = document.getElementById('itemDescription')?.value?.trim();
    const qty = parseInt(document.getElementById('itemQuantity')?.value) || 1;
    const rate = parseFloat(document.getElementById('itemRate')?.value) || 0;

    if (!desc) return alert('Please enter item description');

    addItemToList(desc, qty, rate);

    document.getElementById('itemDescription').value = '';
    document.getElementById('itemQuantity').value = 1;
    document.getElementById('itemRate').value = 0;
}

function addItemToList(description, quantity, rate) {
    const item = {
        id: ++itemCounter,
        description,
        quantity,
        rate,
        amount: quantity * rate,
    };
    items.push(item);
    updateItemsTable();
    updateTotals();
}

function removeItem(id) {
    items = items.filter(i => i.id !== id);
    updateItemsTable();
    updateTotals();
}

function updateItemsTable() {
    const tbody = document.getElementById('itemsTableBody');
    if (!tbody) return;

    tbody.innerHTML = '';
    items.forEach(i => {
        tbody.insertAdjacentHTML(
            'beforeend',
            `
            <tr>
                <td>${i.description}</td>
                <td style="text-align:center;">${i.quantity}</td>
                <td style="text-align:center;">${i.rate}</td>
                <td style="text-align:right;">$${i.amount.toFixed(2)}</td>
                <td style="text-align:center;">
                    <span class="item-remove" onclick="removeItem(${i.id})" title="Remove item">
                        <i class="bi bi-x-lg"></i>
                    </span>
                </td>
            </tr>
            `
        );
    });
}

function updateTotals() {
    const subtotal = items.reduce((sum, i) => sum + i.amount, 0);
    const taxRate = 0;
    const tax = subtotal * taxRate / 100;
    const total = subtotal + tax;

    const currency = document.getElementById('currencySelect')?.value || 'USD';
    const symbols = { USD: '$', INR: '₹', EUR: '€' };
    const sym = symbols[currency] || '$';

    const subtotalEl = document.getElementById('subtotalAmount');
    const taxEl = document.getElementById('taxAmount');
    const totalEl = document.getElementById('totalAmount');

    if (subtotalEl) subtotalEl.textContent = `${sym}${subtotal.toFixed(2)}`;
    if (taxEl) taxEl.textContent = `${sym}${tax.toFixed(2)}`;
    if (totalEl) totalEl.textContent = `${sym}${total.toFixed(2)}`;

    // Hidden fields
    const hiddenSubtotal = document.getElementById('hiddenSubtotal');
    const hiddenTax = document.getElementById('hiddenTax');
    const hiddenAmount = document.getElementById('hiddenAmount');

    if (hiddenSubtotal) hiddenSubtotal.value = subtotal.toFixed(2);
    if (hiddenTax) hiddenTax.value = tax.toFixed(2);
    if (hiddenAmount) hiddenAmount.value = total.toFixed(2);
}

/* ======================================================
   Publisher Invoice Modal
====================================================== */
function openPublisherModal() {
    const modal = document.getElementById('publisherModal');
    if (!modal) {
        console.error('Publisher modal not found');
        return;
    }

    modal.classList.add('show');
    document.body.style.overflow = 'hidden';

    // FIX: Add [0] at the end
    const today = new Date().toISOString().split('T')[0];  // ✅ FIXED
    const dueDate = new Date();
    dueDate.setDate(dueDate.getDate() + 30);
    const dueDateStr = dueDate.toISOString().split('T')[0];  // ✅ FIXED

    const form = document.getElementById('publisherInvoiceForm');
    if (form) {
        const dateInput = form.querySelector('input[name="date"]');
        const dueInput = form.querySelector('input[name="due_date"]');

        if (dateInput) dateInput.value = today;
        if (dueInput) dueInput.value = dueDateStr;

        let pt = form.querySelector('input[name="party_type"]');
        if (!pt) {
            pt = document.createElement('input');
            pt.type = 'hidden';
            pt.name = 'party_type';
            form.appendChild(pt);
        }
        pt.value = 'publisher';

        const inv = form.querySelector('input[name="invoice_number"]');
        if (inv && !inv.value) {
            inv.value = 'PUB-' + Math.floor(100000 + Math.random() * 900000);
        }
    }

    const progressBar = modal.querySelector('.upload-progress');
    const progressFill = modal.querySelector('.upload-progress-bar');
    if (progressBar && progressFill) {
        progressBar.style.display = 'none';
        progressFill.style.width = '0%';
    }
}

function closePublisherModal() {
    const modal = document.getElementById('publisherModal');
    if (!modal) return;

    modal.classList.remove('show');
    document.body.style.overflow = '';

    const form = document.getElementById('publisherInvoiceForm');
    if (form) form.reset();

    const progressBar = modal.querySelector('.upload-progress');
    const progressFill = modal.querySelector('.upload-progress-bar');
    if (progressBar && progressFill) {
        progressBar.style.display = 'none';
        progressFill.style.width = '0%';
    }
}

/* ======================================================
   DOM Hooks and Form Submissions
====================================================== */
document.addEventListener('DOMContentLoaded', () => {

    // Update totals on currency change
    const currencySelect = document.getElementById('currencySelect');
    if (currencySelect) currencySelect.addEventListener('change', updateTotals);

    // Advertiser select auto-fill
    const advSelect = document.getElementById('advertiserSelect');
    if (advSelect) {
        advSelect.addEventListener('change', function () {
            const opt = this.options[this.selectedIndex];
            const company = opt.getAttribute('data-company') || '';
            const contact = opt.getAttribute('data-contact') || '';
            const email = opt.getAttribute('data-email') || '';

            const billTo = document.getElementById('billToTextarea');
            if (billTo) billTo.value = [company, contact, email].filter(Boolean).join('\n');

            // Default item for advertiser
            const defItem = opt.getAttribute('data-item') || 'Service';
            const defQty = parseInt(opt.getAttribute('data-qty') || '1');
            const defRate = parseFloat(opt.getAttribute('data-rate') || '0');

            items = [];
            itemCounter = 0;
            if (defItem) addItemToList(defItem, defQty, defRate);
        });
    }

    // Backdrop click closes modal
    const invoiceModal = document.getElementById('invoiceModal');
    if (invoiceModal) {
        invoiceModal.addEventListener('click', e => {
            if (e.target === e.currentTarget) closeInvoiceModal();
        });
    }

    const publisherModal = document.getElementById('publisherModal');
    if (publisherModal) {
        publisherModal.addEventListener('click', e => {
            if (e.target === e.currentTarget) closePublisherModal();
        });
    }

    // Esc key closes open modals
    document.addEventListener('keydown', e => {
        const advOpen = document.getElementById('invoiceModal')?.classList.contains('show');
        const pubOpen = document.getElementById('publisherModal')?.classList.contains('show');
        if (e.key === 'Escape') {
            if (advOpen) closeInvoiceModal();
            if (pubOpen) closePublisherModal();
        }
    });

    /* --------------------------------------
       Advertiser Form Submit (AJAX)
    -------------------------------------- */
    const advForm = document.getElementById('invoiceForm');
    if (advForm) {
        if (!advForm.getAttribute('action')) {
            advForm.setAttribute('action', advForm.dataset.createUrl || '');
        }

        advForm.addEventListener('submit', function (e) {
            e.preventDefault();

            const advertiserId = advForm.querySelector('select[name="advertiser"]')?.value;
            if (!advertiserId || advertiserId === 'Select Advertiser') {
                alert('Please select an advertiser');
                return;
            }

            updateTotals();
            const formData = new FormData(advForm);
            formData.set('party_type', 'advertiser');

            const submitBtn = advForm.querySelector('.btn-save');
            const originalText = submitBtn?.textContent || 'Save Invoice';
            if (submitBtn) {
                submitBtn.textContent = 'Saving...';
                submitBtn.disabled = true;
            }

            const xhr = new XMLHttpRequest();
            xhr.open('POST', advForm.action);
            xhr.setRequestHeader('X-Requested-With', 'XMLHttpRequest');

            const csrftoken = getCookie('csrftoken');
            if (csrftoken) xhr.setRequestHeader('X-CSRFToken', csrftoken);

            xhr.onload = () => {
                try {
                    if (xhr.status === 200) {
                        const resp = JSON.parse(xhr.responseText);
                        if (resp.success && resp.redirect_url) {
                            closeInvoiceModal();
                            window.location.href = resp.redirect_url;
                            return;
                        }
                        let msg = resp.message || 'Please fix the errors.';
                        if (resp.errors) {
                            msg += '\n\n' + Object.values(resp.errors).flat().join('\n');
                        }
                        alert(msg);
                    } else {
                        alert('Save failed. HTTP ' + xhr.status + ' ' + xhr.statusText);
                    }
                } catch {
                    closeInvoiceModal();
                    window.location.href = advForm.dataset.listUrlAdv || '';
                } finally {
                    if (submitBtn) {
                        submitBtn.textContent = originalText;
                        submitBtn.disabled = false;
                    }
                }
            };

            xhr.onerror = () => {
                alert('Network error. Please try again.');
                if (submitBtn) {
                    submitBtn.textContent = originalText;
                    submitBtn.disabled = false;
                }
            };

            xhr.send(formData);
        });
    }

    /* --------------------------------------
       Publisher Form Submit (AJAX + Upload)
    -------------------------------------- */
    const publisherForm = document.getElementById('publisherInvoiceForm');
    if (publisherForm) {
        const fileInput = publisherForm.querySelector('input[name="pdf"]');
        const progressBar = publisherForm.querySelector('.upload-progress');
        const progressFill = publisherForm.querySelector('.upload-progress-bar');

        if (fileInput) {
			fileInput.addEventListener('change', function () {
				const file = this.files?.[0];  // ✅ FIXED - Added [0]
				if (!file) return;

				if (file.size > 10 * 1024 * 1024) {
					alert('File size must be less than 10MB');
					this.value = '';
					return;
				}

				const allowedTypes = ['application/pdf', 'image/jpeg', 'image/png', 'image/gif'];
				const validType = allowedTypes.includes(file.type);
				if (!validType) {
					alert('Please select a valid PDF or image file');
					this.value = '';
					return;
				}

				const fileInfo = this.parentElement?.querySelector('.file-info small');
				if (fileInfo) {
					fileInfo.textContent = `Selected: ${file.name} (${(file.size / 1024 / 1024).toFixed(2)} MB)`;
					fileInfo.style.color = '#28a745';
				}
			});
		}

        publisherForm.addEventListener('submit', function (e) {
            e.preventDefault();

            const publisherId = this.querySelector('select[name="publisher"]')?.value;
			const amount = parseFloat(this.querySelector('input[name="amount"]')?.value || '0');
			const file = this.querySelector('input[name="pdf"]')?.files?.[0];  // ✅ FIXED - Added [0]

            if (!publisherId) return alert('Please select a publisher');
            if (!amount || amount <= 0) return alert('Please enter a valid amount');

            const formData = new FormData(this);
            formData.set('party_type', 'publisher');
            formData.set('publisher', publisherId);
            formData.set('subtotal', amount.toFixed(2));
            formData.set('gst_amount', '0');
            formData.set('total_amount', amount.toFixed(2));
            formData.set('amount', amount.toFixed(2));

            if (!formData.get('terms')) {
                formData.set('terms', 'Thanks for your business.');
            }

            const inv = this.querySelector('input[name="invoice_number"]');
            if (inv && !inv.value) {
                const newInv = 'PUB-' + Math.floor(100000 + Math.random() * 900000);
                inv.value = newInv;
                formData.set('invoice_number', newInv);
            }

            const submitBtn = this.querySelector('.btn-save');
            const originalText = submitBtn?.textContent || 'Save Invoice';
            if (submitBtn) {
                submitBtn.textContent = 'Uploading...';
                submitBtn.disabled = true;
            }

            if (progressBar && progressFill) {
                progressBar.style.display = 'block';
                progressFill.style.width = '0%';
            }

            const xhr = new XMLHttpRequest();
            xhr.open('POST', this.action);
            xhr.setRequestHeader('X-Requested-With', 'XMLHttpRequest');

            const csrftoken = getCookie('csrftoken');
            if (csrftoken) xhr.setRequestHeader('X-CSRFToken', csrftoken);

            if (xhr.upload && progressFill && submitBtn) {
                xhr.upload.addEventListener('progress', ev => {
                    if (ev.lengthComputable) {
                        const pc = (ev.loaded / ev.total) * 100;
                        progressFill.style.width = pc + '%';
                        submitBtn.textContent = `Uploading... ${Math.round(pc)}%`;
                    }
                });
            }

            xhr.onload = () => {
                if (xhr.status === 200) {
                    try {
                        const resp = JSON.parse(xhr.responseText);
                        if (resp.success && resp.redirect_url) {
                            alert(resp.message || 'Invoice uploaded successfully!');
                            closePublisherModal();
                            window.location.href = resp.redirect_url;
                            return;
                        }
                        let msg = resp.message || 'Please check your input and try again.';
                        if (resp.errors) {
                            msg += '\n\nDetails:\n' + Object.values(resp.errors).flat().join('\n');
                        }
                        alert(msg);
                    } catch {
                        closePublisherModal();
                        window.location.href = publisherForm.dataset.listUrlPub || '';
                    }
                } else {
                    alert('Upload failed. Server returned: ' + xhr.status + ' ' + xhr.statusText);
                }
            };

            xhr.onerror = () => alert('Network error. Please try again.');

            xhr.onloadend = () => {
                if (submitBtn) {
                    submitBtn.textContent = originalText;
                    submitBtn.disabled = false;
                }
                if (progressBar && progressFill) {
                    setTimeout(() => {
                        progressBar.style.display = 'none';
                        progressFill.style.width = '0%';
                    }, 1000);
                }
            };

            xhr.send(formData);
        });
    }
});
</script>
{% endblock %}
